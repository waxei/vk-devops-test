# Система мониторинга веб-приложения

## Описание

Решение представляет собой систему мониторинга простого веб-приложения с автоматическим перезапуском при сбоях. Приложение возвращает "Hello World!" и имеет health-check endpoint для проверки работоспособности.

## Архитектура решения

### Компоненты системы

1. **Веб-приложение** (`app.py`)
   - Простой HTTP-сервер на Python
   - Основной endpoint `/` возвращает "Hello World!"
   - Health-check endpoint `/health` для мониторинга
   - Порт настраивается через переменную окружения `APP_PORT`

2. **Скрипт мониторинга** (`monitor.sh`)
   - Проверяет доступность приложения через HTTP-запросы
   - Логирует результаты проверок с временными метками
   - Автоматически перезапускает приложение при достижении лимита ошибок
   - Работает в бесконечном цикле с настраиваемым интервалом

3. **Конфигурация** (`config.env`)
   - Параметризованные настройки системы
   - URL для проверки, интервал проверок, лимит ошибок
   - Пути к лог-файлам и имя сервиса

4. **Автоматизация установки** (`Makefile`)
   - Автоматическая проверка и установка зависимостей (curl)
   - Поддержка различных менеджеров пакетов (apt-get, yum, dnf)
   - Автоматическая установка и обновление всех компонентов
   - Настройка systemd-сервисов для автозапуска
   - Настройка прав доступа и ротации логов

## Технические детали

### Механизм мониторинга

- Скрипт выполняет HTTP-запросы к health-check endpoint каждые N секунд (настраивается в `config.env`)
- Используется счетчик ошибок: при достижении порога `MAX_RETRIES` выполняется перезапуск
- После перезапуска проверяется успешность: статус сервиса и ответ health-check endpoint
- После успешного восстановления счетчик сбрасывается
- При неудачном перезапуске счетчик не сбрасывается, чтобы избежать зацикливания

### Логирование

- Все события записываются в файл с временными метками
- Уровни логирования: INFO, WARN, ERROR, CRITICAL
- Настроена ротация логов через logrotate (7 дней, ежедневная ротация)

### Автозапуск

- Оба сервиса (приложение и мониторинг) настроены как systemd-сервисы
- Автоматический запуск при старте системы через `WantedBy=multi-user.target`
- Приложение перезапускается при сбоях (`Restart=on-failure`)
- Мониторинг всегда перезапускается (`Restart=always`)

### Безопасность

- Приложение запускается от непривилегированного пользователя `monitoring-user`
- Мониторинг запускается от root (необходимо для `systemctl restart`)
- Правильная настройка прав доступа к файлам и директориям

## Установка

**Требования:**
- Python 3
- Система с systemd
- Права sudo для установки

**Примечание:** Скрипт установки автоматически проверит и установит curl, если он отсутствует.

```bash
# Установка/обновление системы
sudo make install

# Проверка статуса
sudo systemctl status test-app
sudo systemctl status test-monitor

# Просмотр логов
sudo journalctl -u test-app -f
sudo tail -f /var/log/test-monitoring/monitor.log
```

## Удаление

```bash
sudo make uninstall
```

## Настройка

Все параметры настраиваются в файле `/etc/monitoring/config.env`:

- `APP_PORT` - порт веб-приложения (по умолчанию: 8080)
- `TARGET_URL` - URL для проверки здоровья приложения
- `SERVICE_NAME` - имя systemd-сервиса приложения
- `CHECK_INTERVAL` - интервал проверок в секундах (по умолчанию: 5)
- `MAX_RETRIES` - количество неудачных попыток перед перезапуском (по умолчанию: 3)
- `LOG_FILE` - путь к файлу логов мониторинга

После изменения конфигурации необходимо перезапустить сервисы:

```bash
sudo systemctl restart test-app test-monitor
```

## Структура файлов

```
/opt/test-monitoring/          # Установочная директория
  ├── app.py                   # Веб-приложение
  └── monitor.sh               # Скрипт мониторинга

/etc/monitoring/               # Конфигурация
  └── config.env               # Параметры системы

/var/log/test-monitoring/      # Логи
  └── monitor.log              # Лог мониторинга

/etc/systemd/system/           # Systemd сервисы
  ├── test-app.service         # Сервис приложения
  └── test-monitor.service     # Сервис мониторинга
```

## Проверка работы

1. Проверка основного endpoint:
   ```bash
   curl http://localhost:8080/
   # Ожидаемый ответ: Hello World!
   ```

2. Проверка health-check:
   ```bash
   curl http://localhost:8080/health
   # Ожидаемый ответ: OK
   ```

3. Симуляция сбоя (для тестирования мониторинга):
   ```bash
   sudo systemctl stop test-app
   # Через несколько проверок (MAX_RETRIES * CHECK_INTERVAL) 
   # приложение должно автоматически перезапуститься
   ```

